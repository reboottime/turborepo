name: CI

on:
  push:
    branches: [main]
  pull_request:
    types: [opened, synchronize]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

env:
  TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
  TURBO_TEAM: ${{ vars.TURBO_TEAM }}
  REGISTRY: ghcr.io
  API_IMAGE_NAME: ${{ github.repository }}/api

jobs:
  quality:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - uses: ./.github/actions/setup

      - run: pnpm turbo run lint check-types

  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - uses: ./.github/actions/setup

      - run: pnpm turbo run test

  build:
    name: Build
    needs: [quality, test]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - uses: ./.github/actions/setup

      - run: pnpm turbo run build

      - uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: apps/web/.next
          retention-days: 1
          include-hidden-files: true

      - uses: actions/upload-artifact@v4
        with:
          name: portal-build
          path: apps/portal/.next
          retention-days: 1
          include-hidden-files: true

      - uses: actions/upload-artifact@v4
        with:
          name: api-build
          path: |
            apps/api/dist
            apps/api/prisma
            apps/api/package.json
          retention-days: 1

  build-api-image:
    name: Build API Image
    needs: [build]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
    steps:
      - uses: actions/checkout@v4
        with:
          sparse-checkout: |
            apps/api/Dockerfile
            apps/api/.dockerignore

      - uses: actions/download-artifact@v4
        with:
          name: api-build
          path: apps/api

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.API_IMAGE_NAME }}
          tags: |
            type=sha,prefix=,format=long
            type=ref,event=pr
            type=ref,event=branch

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: apps/api
          file: apps/api/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  e2e:
    name: E2E
    needs: [build-api-image]
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: employee_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v4

      - uses: ./.github/actions/setup

      - uses: actions/download-artifact@v4
        with:
          name: portal-build
          path: apps/portal/.next

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Start API container
        run: |
          docker run -d \
            --name api \
            --network host \
            -e DATABASE_URL="postgresql://test:test@localhost:5432/employee_db" \
            -e JWT_SECRET="test-secret" \
            -e ADMIN_EMAIL="admin@test.com" \
            -e ADMIN_PASSWORD="test123" \
            -e PORT=3002 \
            ${{ env.REGISTRY }}/${{ env.API_IMAGE_NAME }}:${{ github.sha }}

      - name: Wait for API to be ready
        run: |
          echo "Waiting for API..."
          for i in {1..30}; do
            if curl -s http://localhost:3002/health > /dev/null; then
              echo "API is ready!"
              break
            fi
            echo "Attempt $i: API not ready yet..."
            sleep 2
          done

      - name: Run database migrations and seed
        working-directory: apps/api
        run: |
          pnpm exec prisma migrate deploy
          pnpm exec prisma db seed
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/employee_db

      - name: Install Playwright browsers
        run: pnpm --filter @repo/portal exec playwright install --with-deps chromium
# Portal is where the app has e2e
      - name: Run E2E tests
        run: pnpm --filter @repo/portal test:e2e
        env:
          NEXT_PUBLIC_API_URL: http://localhost:3002

      - uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-report
          path: apps/portal/playwright-report
          retention-days: 7

      - name: Stop API container
        if: always()
        run: docker stop api || true
