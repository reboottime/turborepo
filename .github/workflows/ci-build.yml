name: CI - Build

on:
  push:
    branches: [main]
  pull_request:
    types: [opened, synchronize]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

env:
  TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
  TURBO_TEAM: ${{ vars.TURBO_TEAM }}

jobs:
  # Detect which packages changed for conditional jobs
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      ui: ${{ steps.filter.outputs.ui }}
    steps:
      - uses: actions/checkout@v4

      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            ui:
              - 'packages/ui/**'

  quality:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - uses: ./.github/actions/setup

      - run: pnpm turbo run lint check-types

  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - uses: ./.github/actions/setup

      - run: pnpm turbo run test

  chromatic:
    name: Visual Review
    needs: [changes]
    if: needs.changes.outputs.ui == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: ./.github/actions/setup

      - name: Build Storybook
        run: pnpm turbo run build-storybook --filter=@repo/ui

      - name: Run Chromatic
        uses: chromaui/action@latest
        with:
          projectToken: ${{ secrets.CHROMATIC_PROJECT_TOKEN }}
          workingDir: packages/ui
          storybookBuildDir: storybook-static
          onlyChanged: true
          autoAcceptChanges: main
          exitZeroOnChanges: true
          externals: |
            packages/ui/src/styles/**

  build:
    name: Build
    needs: [quality, test]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - uses: ./.github/actions/setup

      - run: pnpm turbo run build
        env:
          NEXT_PUBLIC_API_URL: http://localhost:3002

      - uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: apps/web/.next
          retention-days: 1
          include-hidden-files: true

      - uses: actions/upload-artifact@v4
        with:
          name: portal-build
          path: apps/portal/.next
          retention-days: 1
          include-hidden-files: true

      - name: Generate Prisma client for production
        run: |
          pnpm --filter @repo/api exec prisma generate

          # Find the Prisma client path (handles version variations)
          PRISMA_CLIENT_PATH=$(find node_modules/.pnpm -path "*/@prisma+client@*/node_modules/.prisma" -type d 2>/dev/null | head -1)

          if [ -z "$PRISMA_CLIENT_PATH" ]; then
            echo "Error: Could not find generated Prisma client"
            echo "Contents of node_modules/.pnpm:"
            ls -la node_modules/.pnpm/ | head -20
            exit 1
          fi

          echo "Found Prisma client at: $PRISMA_CLIENT_PATH"
          mkdir -p apps/api/node_modules/.prisma
          cp -r "$PRISMA_CLIENT_PATH"/* apps/api/node_modules/.prisma/

          # Verify copy succeeded
          if [ ! -d "apps/api/node_modules/.prisma/client" ]; then
            echo "Error: Prisma client copy failed"
            ls -la apps/api/node_modules/.prisma/ || true
            exit 1
          fi

          echo "Prisma client copied successfully:"
          ls -la apps/api/node_modules/.prisma/

      - uses: actions/upload-artifact@v4
        with:
          name: api-build
          path: |
            apps/api/dist
            apps/api/prisma
            apps/api/package.json
            apps/api/node_modules/.prisma
          retention-days: 1
          include-hidden-files: true
